---
import Base from '../../layouts/Base.astro';
import ChannelSection from '../../components/ChannelSection.astro';
import type { DailyIssue } from '../../../scripts/lib/types';
import { readdirSync, readFileSync, existsSync } from 'fs';
import { join } from 'path';

export function getStaticPaths() {
  const issuesDir = join(process.cwd(), 'data', 'issues');

  if (!existsSync(issuesDir)) {
    return [];
  }

  const files = readdirSync(issuesDir).filter(f => f.endsWith('.json'));

  return files.map(file => {
    const date = file.replace('.json', '');
    const content = readFileSync(join(issuesDir, file), 'utf-8');
    const issue = JSON.parse(content) as DailyIssue;

    return {
      params: { date },
      props: { issue },
    };
  });
}

interface Props {
  issue: DailyIssue;
}

const { issue } = Astro.props;

const formattedDate = new Date(issue.date).toLocaleDateString('en-US', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Separate active and not-important channels
const activeChannels = issue.channels?.filter(c => c.status === 'active') || [];
const quietChannels = issue.channels?.filter(c => c.status === 'not-important') || [];
---

<Base title={issue.title}>
  <article class="space-y-8">
    <header>
      <a
        href="/"
        class="inline-flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to all issues
      </a>

      <h1 class="mt-4 text-3xl font-bold">{issue.title}</h1>

      <div class="mt-2 flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
        <time datetime={issue.date}>{formattedDate}</time>
        <span>•</span>
        <span>{issue.stats?.totalMessages || 0} messages processed</span>
        <span>•</span>
        <span>{issue.stats?.activeChannels || activeChannels.length} active channels</span>
      </div>
    </header>

    {activeChannels.length > 0 && (
      <section>
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span class="w-2 h-2 bg-green-500 rounded-full"></span>
          Active Channels
        </h2>
        <div class="space-y-4">
          {activeChannels.map(channel => (
            <ChannelSection channel={channel} />
          ))}
        </div>
      </section>
    )}

    {quietChannels.length > 0 && (
      <section>
        <h2 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-2">
          <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
          Quiet Channels ({quietChannels.length})
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          {quietChannels.map(channel => (
            <ChannelSection channel={channel} />
          ))}
        </div>
      </section>
    )}

    <footer class="pt-8 border-t border-gray-200 dark:border-gray-700">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Data Sources</h3>
      <div class="mt-2 flex flex-wrap gap-2">
        {(issue.stats?.sourcesUsed || []).map(source => (
          <span class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 rounded font-mono">
            {source}
          </span>
        ))}
      </div>
    </footer>
  </article>
</Base>
